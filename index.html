<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Calculadora Blindada PRO 4.0 | HVAC</title>
    <meta name="description" content="Ferramenta PWA profissional para t√©cnicos de refrigera√ß√£o.">
    <meta name="theme-color" content="#0f172a">

    <!-- PWA MANIFEST -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- FAVICON -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ùÑÔ∏è</text></svg>">

    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9; 
            -webkit-font-smoothing: antialiased;
            overscroll-behavior-y: contain;
        }
        
        /* Previne zoom em inputs no iOS */
        input, select, textarea { font-size: 16px !important; }
        
        .input-field:focus { 
            border-color: #2563eb; 
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); 
        }

        /* ACORDE√ÉO */
        .accordion-content { 
            max-height: 0; 
            opacity: 0; 
            overflow: hidden; 
            transition: all 0.3s ease-in-out;
        }
        .accordion-open .accordion-content { 
            max-height: 1000px !important; 
            opacity: 1 !important;
        }
        .accordion-icon { transition: transform 0.3s ease; }
        .accordion-open .accordion-icon { transform: rotate(180deg); }

        .modal-overlay { background-color: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); }
        
        /* Anima√ß√µes */
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { 
                position: absolute; left: 0; top: 0; width: 100%; 
                background: white; display: block !important; z-index: 9999;
            }
            .no-print { display: none !important; }
            @page { margin: 1cm; size: A4; }
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="app-wrapper min-h-[100dvh] flex flex-col items-center justify-center p-3 sm:p-4 no-print pb-24">
        
        <!-- CARD PRINCIPAL -->
        <div class="w-full max-w-md bg-white rounded-3xl overflow-hidden border border-slate-200 shadow-2xl relative z-10 flex flex-col">
            
            <!-- CABE√áALHO -->
            <header class="bg-[#0f172a] text-white p-6 pb-12 relative overflow-hidden flex justify-between items-start">
                <div class="absolute top-0 right-0 w-40 h-40 bg-blue-600 rounded-full opacity-20 blur-3xl transform translate-x-10 -translate-y-10 pointer-events-none"></div>
                
                <div class="z-10 flex items-center gap-3">
                    <div id="headerLogoArea" class="hidden w-12 h-12 bg-white rounded-lg overflow-hidden flex items-center justify-center border border-slate-700 shadow-lg">
                        <img id="headerLogoImg" src="" alt="Logo" class="w-full h-full object-contain">
                    </div>
                    <div>
                        <div class="flex items-center gap-2 mb-1 opacity-90">
                            <i class="fa-solid fa-snowflake text-blue-400 text-xl animate-pulse"></i>
                            <span class="text-[10px] font-bold uppercase tracking-widest text-blue-200">Refrigera√ß√£o</span>
                        </div>
                        <h1 class="text-xl font-black uppercase tracking-wide text-white leading-tight">
                            Calc <span class="text-blue-500">PRO 4.0</span>
                        </h1>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="toggleHistory()" class="z-10 text-white bg-white/10 hover:bg-white/20 transition-colors p-2.5 rounded-xl backdrop-blur-md" title="Hist√≥rico">
                        <i class="fa-solid fa-clock-rotate-left"></i>
                    </button>
                    <button onclick="toggleSettings()" class="z-10 text-white bg-white/10 hover:bg-white/20 transition-colors p-2.5 rounded-xl backdrop-blur-md" title="Configura√ß√µes">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                </div>
            </header>

            <!-- CONTE√öDO -->
            <div class="relative -mt-8 bg-white rounded-t-[2rem] px-5 pt-8 pb-8 flex-grow shadow-[0_-10px_20px_-5px_rgba(0,0,0,0.1)]">
                
                <!-- TELA 1: INPUTS -->
                <div id="input-section" class="space-y-6">
                    
                    <!-- Dados Cliente -->
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 space-y-3 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                        <label class="block text-xs font-bold text-blue-600 uppercase tracking-wide mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-user-tag"></i> Dados do Or√ßamento
                        </label>
                        
                        <input type="text" id="nomePrestador" placeholder="Seu Nome / Sua Empresa" class="input-field w-full p-3 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-700 focus:outline-none placeholder-slate-400 transition-all">
                        
                        <div class="grid grid-cols-2 gap-3">
                            <input type="text" id="nomeCliente" placeholder="Nome do Cliente" class="col-span-2 input-field w-full p-3 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-700 focus:outline-none placeholder-slate-400 transition-all">
                            
                            <!-- Telefone com M√°scara -->
                            <input type="tel" id="telefoneCliente" placeholder="(DD) 9XXXX-XXXX" maxlength="15" onkeyup="mascaraTelefone(this)" class="col-span-2 input-field w-full p-3 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-700 focus:outline-none placeholder-slate-400 transition-all">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2">
                            <div class="col-span-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Data</label>
                                <input type="date" id="dataServico" class="input-field w-full p-2 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-700 focus:outline-none text-center">
                            </div>
                            <div class="col-span-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Hora</label>
                                <input type="time" id="horaServico" value="09:00" class="input-field w-full p-2 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-700 focus:outline-none text-center">
                            </div>
                            <div class="col-span-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Garantia</label>
                                <div class="relative">
                                    <input type="number" id="inputGarantia" placeholder="90" value="90" class="input-field w-full p-2 pr-6 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-700 focus:outline-none text-center">
                                    <span class="absolute right-2 top-1/2 -translate-y-1/2 text-[9px] text-slate-400 font-bold">D</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Servi√ßos -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-center px-1">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wide flex items-center gap-2">
                                <i class="fa-solid fa-screwdriver-wrench"></i> Servi√ßos
                            </label>
                            <span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-bold">Itens</span>
                        </div>
                        <div id="services-container" class="space-y-3"></div>
                        
                        <button onclick="adicionarServico()" class="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-xs font-bold text-slate-500 hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50 transition-all flex items-center justify-center gap-2 active:scale-95">
                            <i class="fa-solid fa-circle-plus"></i> ADICIONAR ITEM
                        </button>
                        
                        <div class="relative">
                            <i class="fa-solid fa-pen-to-square absolute top-3 left-3 text-slate-300 text-xs"></i>
                            <textarea id="detalhesServico" rows="2" placeholder="Observa√ß√µes t√©cnicas (Ex: Tubula√ß√£o de cobre, suporte...)" class="input-field w-full pl-9 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium text-slate-700 focus:outline-none resize-none placeholder-slate-400 transition-all"></textarea>
                        </div>
                    </div>

                    <!-- Custos -->
                    <div class="pt-4 border-t border-slate-100">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide ml-1 mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-calculator"></i> Custos Operacionais
                        </label>
                        <div class="relative group mb-3">
                            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-sm">R$</div>
                            <!-- INPUT MASK MONEY -->
                            <input type="text" id="custoPecas" placeholder="0,00" onkeyup="formatarMoeda(this)" class="input-field w-full pl-10 pr-28 py-3 bg-white border border-slate-200 rounded-xl text-lg font-bold text-slate-700 focus:outline-none transition-all" inputmode="numeric">
                            <span class="absolute right-4 top-1/2 -translate-y-1/2 text-xs font-bold text-slate-300 uppercase pointer-events-none bg-slate-50 px-2 py-1 rounded">Material</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="relative">
                                <i class="fa-solid fa-route absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                                <input type="number" id="distanciaKm" placeholder="Km Total" class="input-field w-full pl-9 py-3 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-700 focus:outline-none transition-all" inputmode="numeric">
                            </div>
                            <div class="relative">
                                <i class="fa-regular fa-clock absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                                <input type="number" id="tempoHoras" placeholder="Horas" class="input-field w-full pl-9 py-3 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-700 focus:outline-none transition-all" inputmode="decimal">
                            </div>
                        </div>
                    </div>

                    <button onclick="calcularPrecos()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg shadow-blue-600/30 active:scale-[0.98] transition-transform text-lg mt-4 flex items-center justify-center gap-3">
                        CALCULAR AGORA <i class="fa-solid fa-arrow-right animate-bounce-x"></i>
                    </button>
                </div>

                <!-- TELA 2: RESULTADOS -->
                <div id="results-section" class="hidden space-y-6 animate-slide-up">
                    
                    <!-- Valor Final (Destaque) -->
                    <div class="bg-[#0f172a] p-6 rounded-3xl shadow-xl text-white text-center relative overflow-hidden ring-4 ring-slate-100">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500 rounded-full opacity-20 blur-2xl"></div>
                        <div class="relative z-10">
                            <p class="text-xs font-bold text-blue-300 uppercase mb-2 tracking-widest">Valor Total Sugerido</p>
                            <p class="text-5xl font-black mb-5 tracking-tighter drop-shadow-lg" id="displayPrecoFinal">R$ 0,00</p>
                            
                            <div class="grid grid-cols-2 gap-2 text-left">
                                <div class="bg-white/10 p-2 px-3 rounded-lg border border-white/5 backdrop-blur-sm">
                                    <p class="text-[9px] text-slate-400 uppercase font-bold">Lucro L√≠quido</p>
                                    <p class="text-sm font-bold text-green-400" id="displayLucroLiquido">R$ 0,00</p>
                                </div>
                                <div class="bg-white/10 p-2 px-3 rounded-lg border border-white/5 backdrop-blur-sm">
                                    <p class="text-[9px] text-slate-400 uppercase font-bold">Despesas</p>
                                    <p class="text-sm font-bold text-red-300" id="displayDespesas">R$ 0,00</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bot√µes de A√ß√£o Principais -->
                    <div class="space-y-3">
                        <!-- Bot√£o WhatsApp (Destaque) -->
                        <button onclick="enviarWhatsApp()" class="w-full bg-[#25D366] text-white py-3.5 rounded-xl font-bold text-sm flex items-center justify-center gap-2 hover:bg-[#20bd5a] transition-colors shadow-lg shadow-green-500/20 active:scale-95">
                            <i class="fa-brands fa-whatsapp text-xl"></i> ENVIAR RESUMO NO WHATSAPP
                        </button>

                        <div class="grid grid-cols-2 gap-3">
                             <button onclick="imprimirOrcamento()" class="bg-white border-2 border-slate-100 text-slate-600 py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2 hover:bg-slate-50 transition-colors">
                                <i class="fa-solid fa-file-pdf text-red-500 text-lg"></i> GERAR PDF
                            </button>
                            <button onclick="reiniciar()" class="bg-white border-2 border-slate-100 text-slate-600 py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2 hover:bg-slate-50 transition-colors">
                                <i class="fa-solid fa-rotate-left text-blue-500 text-lg"></i> NOVO C√ÅLCULO
                            </button>
                        </div>
                    </div>
                    
                    <!-- Detalhes Expans√≠veis -->
                    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                        <button onclick="toggleAccordion('acc-details')" class="w-full p-4 flex justify-between items-center bg-slate-50 hover:bg-white transition-colors">
                            <span class="text-xs font-bold text-slate-500 uppercase flex items-center gap-2">
                                <i class="fa-solid fa-list-ul"></i> Ver Detalhamento
                            </span>
                            <i class="fa-solid fa-chevron-down text-slate-400 text-xs accordion-icon"></i>
                        </button>
                        <div id="acc-details" class="accordion-content">
                             <div class="p-4 grid grid-cols-3 gap-2 text-center border-t border-slate-100">
                                <div class="p-2 rounded bg-blue-50">
                                    <div class="text-[9px] text-slate-400 font-bold uppercase">Log√≠stica</div>
                                    <div class="text-xs font-black text-slate-700" id="displayLogistica">R$ 0,00</div>
                                </div>
                                <div class="p-2 rounded bg-green-50">
                                    <div class="text-[9px] text-slate-400 font-bold uppercase">M√£o de Obra</div>
                                    <div class="text-xs font-black text-slate-700" id="displayMaoObra">R$ 0,00</div>
                                </div>
                                <div class="p-2 rounded bg-orange-50">
                                    <div class="text-[9px] text-slate-400 font-bold uppercase">Materiais</div>
                                    <div class="text-xs font-black text-slate-700" id="displayMateriais">R$ 0,00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- √ÅREA DE IMPRESS√ÉO (PDF) -->
    <div id="printable-area" class="hidden">
        <div style="font-family: 'Inter', sans-serif; color: #334155; max-width: 800px; margin: 0 auto; padding: 40px;">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 30px;">
                <div style="display: flex; gap: 20px; align-items: center;">
                    <img id="printLogo" src="" style="height: 70px; width: auto; object-fit: contain; display: none;">
                    <div>
                        <h1 style="font-size: 22px; font-weight: 800; color: #0f172a; margin: 0; line-height: 1.2;" id="printPrestador">Prestador</h1>
                        <p style="font-size: 14px; color: #64748b; margin: 5px 0 0 0;">Or√ßamento Profissional de Refrigera√ß√£o</p>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 12px; font-weight: 700; color: #94a3b8; text-transform: uppercase;">Data de Emiss√£o</div>
                    <div style="font-size: 16px; font-weight: 600; color: #0f172a;" id="printData">--/--/----</div>
                </div>
            </div>

            <!-- Cliente -->
            <div style="background-color: #f8fafc; padding: 25px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #e2e8f0;">
                <table style="width: 100%;">
                    <tr>
                        <td style="vertical-align: top;">
                            <h3 style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #94a3b8; margin: 0 0 8px 0;">Cliente</h3>
                            <p style="font-size: 16px; font-weight: 700; color: #0f172a; margin: 0;" id="printCliente">Nome do Cliente</p>
                            <p style="font-size: 14px; color: #64748b; margin: 4px 0 0 0;" id="printTelefone">Tel: --</p>
                        </td>
                        <td style="vertical-align: top; text-align: right; width: 40%;">
                            <h3 style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #94a3b8; margin: 0 0 8px 0;">Observa√ß√µes</h3>
                            <p style="font-size: 13px; color: #475569; margin: 0; line-height: 1.5;" id="printDetalhes">...</p>
                        </td>
                    </tr>
                </table>
            </div>

            <!-- Tabela -->
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                <thead>
                    <tr style="border-bottom: 2px solid #0f172a;">
                        <th style="text-align: left; padding: 12px 0; font-size: 11px; text-transform: uppercase; color: #0f172a; font-weight: 800;">Descri√ß√£o do Servi√ßo</th>
                        <th style="text-align: center; padding: 12px 0; font-size: 11px; text-transform: uppercase; color: #0f172a; font-weight: 800;">Qtd</th>
                        <th style="text-align: right; padding: 12px 0; font-size: 11px; text-transform: uppercase; color: #0f172a; font-weight: 800;">Subtotal</th>
                    </tr>
                </thead>
                <tbody id="printServicesList" style="font-size: 14px; color: #334155;"></tbody>
            </table>

            <!-- Totais -->
            <div style="display: flex; justify-content: flex-end;">
                <div style="width: 280px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #64748b;">
                        <span>Pe√ßas/Materiais:</span>
                        <span style="font-weight: 600;" id="printMateriais">R$ 0,00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; border-top: 2px solid #e2e8f0; padding-top: 15px; margin-top: 10px;">
                        <span style="font-size: 14px; font-weight: 800; color: #0f172a; text-transform: uppercase;">Total Geral</span>
                        <span style="font-size: 22px; font-weight: 900; color: #0f172a;" id="printTotal">R$ 0,00</span>
                    </div>
                </div>
            </div>

            <!-- Rodap√© -->
            <div style="margin-top: 60px; text-align: center; font-size: 12px; color: #94a3b8; border-top: 1px dashed #cbd5e1; padding-top: 20px;">
                <p>Garantia de <span id="printGarantia" style="font-weight: 700; color: #0f172a;">90 dias</span> sobre os servi√ßos prestados.</p>
                <p style="margin-top: 5px;">Or√ßamento gerado via <strong>Calculadora Blindada PRO</strong></p>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIGURA√á√ïES -->
    <div id="settingsModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0 w-full h-full" onclick="toggleSettings()"></div>
        <div class="absolute inset-x-0 bottom-0 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 w-full max-w-lg bg-white rounded-t-3xl sm:rounded-3xl p-6 h-[85vh] sm:h-auto overflow-y-auto transform transition-transform duration-300 translate-y-full shadow-2xl" id="modalContent">
            
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-lg font-black text-slate-800 uppercase flex items-center gap-2"><i class="fa-solid fa-sliders text-blue-600"></i> Ajustes</h2>
                <button onclick="toggleSettings()" class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center hover:bg-slate-200"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="space-y-6">
                <!-- Branding -->
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <h3 class="text-xs font-bold text-slate-500 uppercase mb-3"><i class="fa-solid fa-image text-blue-500 mr-1"></i> Seu Log√≥tipo</h3>
                    <input type="file" id="logoInput" accept="image/*" onchange="handleLogoUpload(this)" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    <button onclick="removerLogo()" class="text-[10px] text-red-500 font-bold mt-2 uppercase hover:underline">Remover Logo</button>
                </div>

                <!-- Gestor de Servi√ßos -->
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <h3 class="text-xs font-bold text-slate-500 uppercase mb-3"><i class="fa-solid fa-list text-blue-500 mr-1"></i> Pre√ßos Base</h3>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="novoServicoNome" placeholder="Nome do Servi√ßo" class="input-field flex-grow p-2 rounded-lg border border-slate-200 text-xs">
                        <input type="number" id="novoServicoValor" placeholder="R$" class="input-field w-20 p-2 rounded-lg border border-slate-200 text-xs">
                        <button onclick="adicionarServicoBase()" class="bg-blue-600 text-white p-2 rounded-lg"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div id="listaServicosBase" class="max-h-40 overflow-y-auto space-y-1 pr-1"></div>
                </div>
                
                <button onclick="salvarConfiguracoes()" class="w-full bg-[#0f172a] text-white font-bold py-4 rounded-2xl hover:bg-black transition-all shadow-lg">
                    SALVAR ALTERA√á√ïES
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE HIST√ìRICO (NOVO) -->
    <div id="historyModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0 w-full h-full" onclick="toggleHistory()"></div>
        <div class="absolute inset-y-0 right-0 w-full max-w-sm bg-white p-0 h-full overflow-y-auto transform transition-transform duration-300 translate-x-full shadow-2xl flex flex-col" id="historyContent">
            
            <div class="bg-[#0f172a] text-white p-6 pb-6 flex justify-between items-center sticky top-0 z-10">
                <div>
                    <h2 class="text-lg font-black uppercase"><i class="fa-solid fa-clock-rotate-left mr-2"></i> Hist√≥rico</h2>
                    <p class="text-[10px] text-slate-400">√öltimos or√ßamentos salvos</p>
                </div>
                <button onclick="toggleHistory()" class="w-8 h-8 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/20"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div id="historyList" class="flex-grow p-4 space-y-3 bg-slate-50">
                <!-- Itens gerados via JS -->
                <div class="text-center text-slate-400 py-10 text-xs">Nenhum or√ßamento salvo ainda.</div>
            </div>
            
            <div class="p-4 border-t border-slate-200 bg-white">
                <button onclick="limparHistorico()" class="w-full py-3 text-red-500 font-bold text-xs border border-red-100 rounded-xl hover:bg-red-50">
                    LIMPAR TUDO
                </button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // --- SERVICE WORKER REGISTRATION (PWA) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW registrado!', reg.scope))
                    .catch(err => console.log('SW falhou:', err));
            });
        }

        // --- DADOS E ESTADO ---
        const HVAC_SERVICES = [
            { nome: "Instala√ß√£o Split 9000/12000 BTUs", min: 500 },
            { nome: "Instala√ß√£o Split 18000/24000 BTUs", min: 750 },
            { nome: "Instala√ß√£o Piso Teto / Cassete", min: 1200 },
            { nome: "Limpeza e Higieniza√ß√£o (Simples)", min: 200 },
            { nome: "Limpeza Qu√≠mica (Desmontagem)", min: 350 },
            { nome: "Carga de G√°s (R410A/R22/R32)", min: 280 },
            { nome: "Troca de Capacitor / Rel√©", min: 180 },
            { nome: "Corre√ß√£o de Vazamento (Flange)", min: 250 },
            { nome: "Visita T√©cnica / Diagn√≥stico", min: 120 },
            { nome: "Infraestrutura (Metro Linear)", min: 100 }
        ];

        let state = {
            veiculo: 'hatch',
            gasolina: 6.15,
            logoBase64: null,
            meusServicos: [],
            historico: [] // Novo: Array de hist√≥rico
        };

        const DATA_VEICULOS = {
            utilitario: { eficiencia: 10.5, custoKm: 0.88 },
            hatch:      { eficiencia: 11.0, custoKm: 0.45 },
            moto:       { eficiencia: 35.0, custoKm: 0.20 }
        };

        // --- M√ÅSCARAS E FORMATA√á√ÉO (NOVO) ---
        const formatBRL = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        
        function formatarMoeda(input) {
            let v = input.value.replace(/\D/g, "");
            v = (v / 100).toFixed(2) + "";
            v = v.replace(".", ",");
            v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
            input.value = v === "0,00" ? "" : v; // Se for zero, deixa vazio para placeholder aparecer
        }

        function parseMoeda(valorString) {
            if (!valorString) return 0;
            return parseFloat(valorString.replace(/\./g, '').replace(',', '.'));
        }

        function mascaraTelefone(input) {
            let v = input.value.replace(/\D/g, "");
            v = v.substring(0, 11); // Limita a 11 d√≠gitos
            if (v.length > 10) {
                v = v.replace(/^(\d\d)(\d{5})(\d{4}).*/, "($1) $2-$3");
            } else if (v.length > 5) {
                v = v.replace(/^(\d\d)(\d{4})(\d{0,4}).*/, "($1) $2-$3");
            } else if (v.length > 2) {
                v = v.replace(/^(\d\d)(\d{0,5}).*/, "($1) $2");
            } else {
                v = v.replace(/^(\d*)/, "($1");
            }
            input.value = v;
        }

        // --- INICIALIZA√á√ÉO ---
        window.onload = () => {
            loadState();
            
            if(state.meusServicos.length === 0) {
                state.meusServicos = JSON.parse(JSON.stringify(HVAC_SERVICES));
            }

            document.getElementById('dataServico').valueAsDate = new Date();
            adicionarServico(); 
            renderListaServicosBase(); 
        };

        function loadState() {
            const saved = localStorage.getItem('calcBlindadaV4'); // Nova chave V4
            if(saved) { 
                const loaded = JSON.parse(saved);
                state = { ...state, ...loaded };
            }
            applyConfigToUI();
            if (!state.historico) state.historico = [];
        }

        function saveState() {
            localStorage.setItem('calcBlindadaV4', JSON.stringify(state));
        }

        function applyConfigToUI() {
            if(state.logoBase64) {
                document.getElementById('headerLogoArea').classList.remove('hidden');
                document.getElementById('headerLogoImg').src = state.logoBase64;
                document.getElementById('printLogo').src = state.logoBase64;
                document.getElementById('printLogo').style.display = 'block';
            } else {
                document.getElementById('headerLogoArea').classList.add('hidden');
                document.getElementById('printLogo').style.display = 'none';
            }
            document.getElementById('nomePrestador').value = state.prestadorPadrao || "";
        }

        // --- UI DE SERVI√áOS ---
        function adicionarServico() {
            const container = document.getElementById('services-container');
            const div = document.createElement('div');
            div.className = "service-row bg-white p-3 rounded-2xl border border-slate-200 shadow-sm relative animate-slide-up";
            
            let options = `<option value="" disabled selected>Selecione um servi√ßo...</option>`;
            state.meusServicos.forEach(s => {
                options += `<option value="${s.nome}" data-min="${s.min}">${s.nome}</option>`;
            });

            div.innerHTML = `
                <div class="mb-2 pr-6">
                    <select class="service-select w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold text-slate-700 outline-none" onchange="atualizarPrecoInput(this)">
                        ${options}
                    </select>
                </div>
                <div class="flex gap-2">
                    <div class="relative flex-grow">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs font-bold">R$</span>
                        <!-- INPUT MASKED PRICE -->
                        <input type="text" class="service-price w-full pl-8 p-2 bg-white border border-slate-200 rounded-lg text-sm font-bold outline-none" placeholder="0,00" onkeyup="formatarMoeda(this)" inputmode="numeric">
                    </div>
                    <div class="flex items-center border border-slate-200 rounded-lg bg-slate-50 w-24">
                        <button onclick="alterarQtd(this, -1)" class="w-8 h-full text-slate-500 font-bold hover:bg-white rounded-l-lg transition-colors">-</button>
                        <span class="qty-value flex-grow text-center text-sm font-bold text-slate-700">1</span>
                        <button onclick="alterarQtd(this, 1)" class="w-8 h-full text-slate-500 font-bold hover:bg-white rounded-r-lg transition-colors">+</button>
                    </div>
                </div>
                <button onclick="this.closest('.service-row').remove()" class="absolute top-3 right-3 text-slate-300 hover:text-red-400 transition-colors"><i class="fa-solid fa-trash-can"></i></button>
            `;
            container.appendChild(div);
        }

        function atualizarPrecoInput(select) {
            const min = select.options[select.selectedIndex].getAttribute('data-min');
            const input = select.closest('.service-row').querySelector('.service-price');
            // Formata o valor sugerido para exibir na m√°scara
            const val = parseFloat(min).toFixed(2).replace('.', ',');
            input.value = val;
            formatarMoeda(input); // Aplica m√°scara visual
        }
        
        function alterarQtd(btn, delta) {
            const span = btn.parentElement.querySelector('.qty-value');
            let v = parseInt(span.innerText) + delta;
            if(v < 1) v = 1;
            span.innerText = v;
        }

        // --- C√ÅLCULO CORE ---
        function calcularPrecos() {
            let totalServicos = 0;
            let itensParaImpressao = [];
            
            document.querySelectorAll('.service-row').forEach(row => {
                const select = row.querySelector('select');
                if(select.selectedIndex === 0) return;
                
                const nome = select.value;
                const precoRaw = row.querySelector('.service-price').value;
                const preco = parseMoeda(precoRaw); // Parse manual da m√°scara
                const qtd = parseInt(row.querySelector('.qty-value').innerText);
                
                if(nome && preco > 0) {
                    const totalLinha = preco * qtd;
                    totalServicos += totalLinha;
                    itensParaImpressao.push({ nome, qtd, total: totalLinha, unitario: preco });
                }
            });

            if(totalServicos === 0) { alert("Por favor, adicione servi√ßos e valores."); return; }

            const mat = parseMoeda(document.getElementById('custoPecas').value);
            const km = parseFloat(document.getElementById('distanciaKm').value) || 0;
            const garantiaDias = document.getElementById('inputGarantia').value || 90;
            const hora = parseFloat(document.getElementById('tempoHoras').value) || 0;
            
            // Log√≠stica
            const dadosVeiculo = DATA_VEICULOS[state.veiculo] || DATA_VEICULOS.hatch;
            const custoGasolinaKm = state.gasolina / dadosVeiculo.eficiencia;
            const custoLogistica = km * (custoGasolinaKm + dadosVeiculo.custoKm);

            const totalFinal = totalServicos + mat + custoLogistica; 

            // Popula UI Resultados
            document.getElementById('displayLogistica').innerText = formatBRL(custoLogistica);
            document.getElementById('displayMaoObra').innerText = formatBRL(totalServicos);
            document.getElementById('displayMateriais').innerText = formatBRL(mat);
            
            document.getElementById('displayPrecoFinal').innerText = formatBRL(totalFinal);
            document.getElementById('displayLucroLiquido').innerText = formatBRL(totalServicos); 
            document.getElementById('displayDespesas').innerText = formatBRL(mat + custoLogistica); 

            // Objeto de Dados Completo
            window.dadosOrcamento = {
                id: Date.now(), // ID √∫nico para hist√≥rico
                prestador: document.getElementById('nomePrestador').value || "T√©cnico Respons√°vel",
                cliente: document.getElementById('nomeCliente').value || "Cliente",
                telefone: document.getElementById('telefoneCliente').value || "",
                detalhes: document.getElementById('detalhesServico').value || "",
                data: document.getElementById('dataServico').value.split('-').reverse().join('/'),
                hora: document.getElementById('horaServico').value,
                itens: itensParaImpressao,
                total: totalFinal,
                mat: mat,
                garantia: `${garantiaDias} dias`
            };

            // Salvar no Hist√≥rico
            salvarNoHistorico(window.dadosOrcamento);

            // Troca Telas
            document.getElementById('input-section').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- SISTEMA DE HIST√ìRICO ---
        function salvarNoHistorico(dados) {
            // Adiciona no in√≠cio
            state.historico.unshift(dados);
            // Mant√©m apenas os √∫ltimos 10
            if (state.historico.length > 10) state.historico.pop();
            saveState();
        }

        function toggleHistory() {
            const m = document.getElementById('historyModal');
            const c = document.getElementById('historyContent');
            
            if(m.classList.contains('hidden')) {
                renderHistoricoUI();
                m.classList.remove('hidden');
                setTimeout(() => c.classList.remove('translate-x-full'), 10);
            } else {
                c.classList.add('translate-x-full');
                setTimeout(() => m.classList.add('hidden'), 300);
            }
        }

        function renderHistoricoUI() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            
            if (state.historico.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-400 py-10 text-xs">Nenhum or√ßamento recente.</div>';
                return;
            }

            state.historico.forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-white p-3 rounded-xl border border-slate-200 shadow-sm hover:border-blue-300 transition-colors cursor-pointer";
                div.onclick = () => carregarDoHistorico(item);
                
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-sm text-slate-800">${item.cliente}</span>
                        <span class="text-xs font-black text-blue-600">${formatBRL(item.total)}</span>
                    </div>
                    <div class="text-[10px] text-slate-400 flex justify-between">
                        <span>${item.data}</span>
                        <span>${item.itens.length} itens</span>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function carregarDoHistorico(item) {
            if(!confirm("Carregar este or√ßamento? Os dados atuais ser√£o substitu√≠dos.")) return;
            
            // Preencher Inputs
            document.getElementById('nomeCliente').value = item.cliente;
            document.getElementById('telefoneCliente').value = item.telefone || "";
            document.getElementById('nomePrestador').value = item.prestador;
            document.getElementById('detalhesServico').value = item.detalhes;
            document.getElementById('custoPecas').value = item.mat.toFixed(2).replace('.',',');
            formatarMoeda(document.getElementById('custoPecas'));

            // Preencher Servi√ßos
            const container = document.getElementById('services-container');
            container.innerHTML = ''; // Limpa atuais
            
            item.itens.forEach(servico => {
                // Cria a row
                const div = document.createElement('div');
                div.className = "service-row bg-white p-3 rounded-2xl border border-slate-200 shadow-sm relative";
                
                let options = `<option value="" disabled>Selecione...</option>`;
                state.meusServicos.forEach(s => {
                    options += `<option value="${s.nome}" ${s.nome === servico.nome ? 'selected' : ''} data-min="${s.min}">${s.nome}</option>`;
                });

                // Prepara valor formatado
                const valUnit = servico.unitario ? servico.unitario.toFixed(2).replace('.',',') : '0,00';

                div.innerHTML = `
                    <div class="mb-2 pr-6">
                        <select class="service-select w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold text-slate-700 outline-none" onchange="atualizarPrecoInput(this)">${options}</select>
                    </div>
                    <div class="flex gap-2">
                        <div class="relative flex-grow">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs font-bold">R$</span>
                            <input type="text" class="service-price w-full pl-8 p-2 bg-white border border-slate-200 rounded-lg text-sm font-bold outline-none" value="${valUnit}" onkeyup="formatarMoeda(this)" inputmode="numeric">
                        </div>
                        <div class="flex items-center border border-slate-200 rounded-lg bg-slate-50 w-24">
                            <button onclick="alterarQtd(this, -1)" class="w-8 h-full text-slate-500 font-bold hover:bg-white rounded-l-lg transition-colors">-</button>
                            <span class="qty-value flex-grow text-center text-sm font-bold text-slate-700">${servico.qtd}</span>
                            <button onclick="alterarQtd(this, 1)" class="w-8 h-full text-slate-500 font-bold hover:bg-white rounded-r-lg transition-colors">+</button>
                        </div>
                    </div>
                    <button onclick="this.closest('.service-row').remove()" class="absolute top-3 right-3 text-slate-300 hover:text-red-400 transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                `;
                container.appendChild(div);
            });

            // Fecha Modal e vai para tela 1
            toggleHistory();
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('input-section').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function limparHistorico() {
            if(confirm("Tem certeza? Isso apagar√° todos os or√ßamentos salvos.")) {
                state.historico = [];
                saveState();
                renderHistoricoUI();
            }
        }

        // --- WHATSAPP & PDF ---
        function enviarWhatsApp() {
            const d = window.dadosOrcamento;
            if(!d) return;

            // Cria uma mensagem estilo "recibo" bonita
            let msg = `‚ùÑÔ∏è *OR√áAMENTO - ${d.prestador.toUpperCase()}* ‚ùÑÔ∏è\n\n`;
            msg += `üë§ *Cliente:* ${d.cliente}\n`;
            msg += `üìÖ *Data:* ${d.data}\n\n`;
            msg += `*SERVI√áOS REALIZADOS:*\n`;
            
            d.itens.forEach(i => {
                msg += `‚ñ™Ô∏è ${i.qtd}x ${i.nome} - ${formatBRL(i.total)}\n`;
            });

            if (d.detalhes) msg += `\nüìù *Obs:* ${d.detalhes}\n`;
            
            msg += `\nüîß *Pe√ßas/Material:* ${formatBRL(d.mat)}`;
            msg += `\nüõ°Ô∏è *Garantia:* ${d.garantia}`;
            msg += `\n\nüí∞ *TOTAL GERAL: ${formatBRL(d.total)}*`;
            msg += `\n\n_Gerado por Calculadora Blindada PRO_`;

            const encodedMsg = encodeURIComponent(msg);
            
            // Se tiver telefone do cliente, abre direto no chat dele, sen√£o abre sele√ß√£o de contato
            let url = "";
            if(d.telefone) {
                // Remove caracteres do telefone para a API
                const cleanPhone = d.telefone.replace(/\D/g, ""); 
                // Adiciona 55 se n√£o tiver
                const finalPhone = cleanPhone.length <= 11 ? "55" + cleanPhone : cleanPhone;
                url = `https://wa.me/${finalPhone}?text=${encodedMsg}`;
            } else {
                url = `https://wa.me/?text=${encodedMsg}`;
            }

            window.open(url, '_blank');
        }

        function imprimirOrcamento() {
            const d = window.dadosOrcamento;
            if(!d) return;

            document.getElementById('printPrestador').innerText = d.prestador;
            document.getElementById('printCliente').innerText = d.cliente;
            document.getElementById('printTelefone').innerText = d.telefone ? `Tel: ${d.telefone}` : "";
            document.getElementById('printDetalhes').innerText = d.detalhes;
            document.getElementById('printData').innerText = d.data;
            document.getElementById('printMateriais').innerText = formatBRL(d.mat);
            document.getElementById('printTotal').innerText = formatBRL(d.total);
            document.getElementById('printGarantia').innerText = d.garantia;

            const tbody = document.getElementById('printServicesList');
            tbody.innerHTML = '';
            d.itens.forEach(i => {
                tbody.innerHTML += `
                    <tr style="border-bottom: 1px solid #f1f5f9;">
                        <td style="padding: 10px 0;">${i.nome}</td>
                        <td style="padding: 10px 0; text-align: center;">${i.qtd}</td>
                        <td style="padding: 10px 0; text-align: right; font-weight: 600;">${formatBRL(i.total)}</td>
                    </tr>
                `;
            });
            window.print();
        }

        function reiniciar() {
            document.getElementById('input-section').classList.remove('hidden');
            document.getElementById('results-section').classList.add('hidden');
            document.querySelectorAll('.accordion-content').forEach(el => el.classList.remove('accordion-open'));
        }

        // --- UTILS ---
        function toggleSettings() {
            const m = document.getElementById('settingsModal');
            const c = document.getElementById('modalContent');
            if(m.classList.contains('hidden')) {
                m.classList.remove('hidden');
                setTimeout(() => c.classList.remove('translate-y-full'), 10);
                renderListaServicosBase();
            } else {
                c.classList.add('translate-y-full');
                setTimeout(() => m.classList.add('hidden'), 300);
            }
        }
        function toggleAccordion(id) {
            document.getElementById(id).closest('div').classList.toggle('accordion-open');
        }

        // --- GEST√ÉO DE LOGO E SERVI√áOS ---
        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    state.logoBase64 = e.target.result;
                    applyConfigToUI();
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        function removerLogo() {
            state.logoBase64 = null;
            document.getElementById('logoInput').value = "";
            applyConfigToUI();
        }
        function renderListaServicosBase() {
            const container = document.getElementById('listaServicosBase');
            container.innerHTML = '';
            state.meusServicos.forEach((srv, index) => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-white p-2 rounded border border-slate-100 text-xs";
                div.innerHTML = `
                    <span class="font-medium truncate">${srv.nome}</span>
                    <div class="flex items-center gap-2">
                        <span class="text-slate-400 font-bold">R$ ${srv.min}</span>
                        <button onclick="removeServicoBase(${index})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        function adicionarServicoBase() {
            const nome = document.getElementById('novoServicoNome').value.trim();
            const min = parseFloat(document.getElementById('novoServicoValor').value);
            if(nome && !isNaN(min)) {
                state.meusServicos.push({ nome, min });
                document.getElementById('novoServicoNome').value = '';
                document.getElementById('novoServicoValor').value = '';
                renderListaServicosBase();
            }
        }
        function removeServicoBase(index) {
            state.meusServicos.splice(index, 1);
            renderListaServicosBase();
        }
        function salvarConfiguracoes() {
            // Salva nome padr√£o do prestador para agilizar
            state.prestadorPadrao = document.getElementById('nomePrestador').value;
            saveState();
            toggleSettings();
            // location.reload(); // Removido reload para n√£o quebrar fluxo PWA
            applyConfigToUI();
            adicionarServico(); // Reseta lista
        }
    </script>
</body>
</html>